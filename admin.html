<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSVP Admin Dashboard - Jessica & Shail Wedding</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .admin-login {
            max-width: 400px;
            margin: 2rem auto;
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #004030;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .rsvp-table {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .rsvp-table table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .rsvp-table th {
            background: #004030;
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
        }
        
        .rsvp-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #eee;
        }
        
        .rsvp-table tr:hover {
            background: #f8f9fa;
        }
        
        .event-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
            margin: 0.1rem;
        }
        
        .event-yes {
            background: #d4edda;
            color: #155724;
        }
        
        .event-no {
            background: #f8d7da;
            color: #721c24;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <h1>RSVP Admin Dashboard</h1>
        
        <!-- Login Form -->
        <div id="adminLogin" class="admin-login">
            <h2>Admin Login</h2>
            <div class="form-group">
                <label for="adminPassword">Password:</label>
                <input type="password" id="adminPassword" placeholder="Enter admin password">
            </div>
            <button onclick="adminLogin()" class="rsvp-submit">Login</button>
            <div id="loginError" class="error" style="display: none;"></div>
        </div>
        
        <!-- Dashboard Content -->
        <div id="adminDashboard" style="display: none;">
            <div id="loadingMessage" class="loading">
                <i class="fas fa-spinner fa-spin"></i> Loading RSVP data...
            </div>
            
            <div id="dashboardContent" style="display: none;">
                <!-- Statistics -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalRsvps">0</div>
                        <div class="stat-label">Total RSVPs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="responseRate">0%</div>
                        <div class="stat-label">Response Rate</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="mehndiCount">0</div>
                        <div class="stat-label">Mehndi Attendees</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="ceremonyCount">0</div>
                        <div class="stat-label">Ceremony Attendees</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="receptionCount">0</div>
                        <div class="stat-label">Reception Attendees</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalGuests">0</div>
                        <div class="stat-label">Total Guests</div>
                    </div>
                </div>
                
                <!-- RSVP Table -->
                <div class="rsvp-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Guest Name</th>
                                <th>Email</th>
                                <th>Events</th>
                                <th>Guests</th>
                                <th>Submitted</th>
                            </tr>
                        </thead>
                        <tbody id="rsvpTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div id="errorMessage" class="error" style="display: none;"></div>
        </div>
    </div>

    <script>
        let adminToken = null;
        
        async function adminLogin() {
            const password = document.getElementById('adminPassword').value;
            const loginError = document.getElementById('loginError');
            
            if (!password) {
                loginError.textContent = 'Please enter a password';
                loginError.style.display = 'block';
                return;
            }
            
            adminToken = password;
            
            try {
                await loadDashboard();
                document.getElementById('adminLogin').style.display = 'none';
                document.getElementById('adminDashboard').style.display = 'block';
            } catch (error) {
                loginError.textContent = 'Invalid password or server error';
                loginError.style.display = 'block';
                adminToken = null;
            }
        }
        
        async function loadDashboard() {
            const loadingMessage = document.getElementById('loadingMessage');
            const dashboardContent = document.getElementById('dashboardContent');
            const errorMessage = document.getElementById('errorMessage');
            
            loadingMessage.style.display = 'block';
            dashboardContent.style.display = 'none';
            errorMessage.style.display = 'none';
            
            try {
                const response = await fetch('/.netlify/functions/get-rsvp-stats', {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch data');
                }
                
                const data = await response.json();
                populateDashboard(data);
                
                loadingMessage.style.display = 'none';
                dashboardContent.style.display = 'block';
                
            } catch (error) {
                loadingMessage.style.display = 'none';
                errorMessage.textContent = 'Error loading dashboard: ' + error.message;
                errorMessage.style.display = 'block';
            }
        }
        
        function populateDashboard(data) {
            // Update statistics
            document.getElementById('totalRsvps').textContent = data.summary.total_rsvps || 0;
            document.getElementById('responseRate').textContent = data.responseRate + '%';
            document.getElementById('mehndiCount').textContent = data.summary.mehndi_attendees || 0;
            document.getElementById('ceremonyCount').textContent = data.summary.ceremony_attendees || 0;
            document.getElementById('receptionCount').textContent = data.summary.reception_attendees || 0;
            
            const totalGuests = (parseInt(data.summary.total_mehndi_guests) || 0) + 
                              (parseInt(data.summary.total_ceremony_guests) || 0) + 
                              (parseInt(data.summary.total_reception_guests) || 0);
            document.getElementById('totalGuests').textContent = totalGuests;
            
            // Populate RSVP table
            const tableBody = document.getElementById('rsvpTableBody');
            tableBody.innerHTML = '';
            
            data.rsvps.forEach(rsvp => {
                const row = document.createElement('tr');
                
                // Events column
                let events = [];
                if (rsvp.mehndi_attending) events.push(`<span class="event-badge event-yes">Mehndi (${rsvp.mehndi_guests})</span>`);
                if (rsvp.ceremony_attending) events.push(`<span class="event-badge event-yes">Ceremony (${rsvp.ceremony_guests})</span>`);
                if (rsvp.reception_attending) events.push(`<span class="event-badge event-yes">Reception (${rsvp.reception_guests})</span>`);
                
                const totalGuestsForPerson = (rsvp.mehndi_guests || 0) + (rsvp.ceremony_guests || 0) + (rsvp.reception_guests || 0);
                
                row.innerHTML = `
                    <td>${rsvp.guest_name}</td>
                    <td>${rsvp.email}</td>
                    <td>${events.join(' ')}</td>
                    <td>${totalGuestsForPerson}</td>
                    <td>${new Date(rsvp.created_at).toLocaleDateString()}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // Auto-refresh every 30 seconds if logged in
        setInterval(() => {
            if (adminToken && document.getElementById('dashboardContent').style.display !== 'none') {
                loadDashboard();
            }
        }, 30000);
    </script>
</body>
</html>
